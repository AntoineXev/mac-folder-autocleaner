#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" && pwd)"
ROOT_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"

source "$ROOT_DIR/lib/cli.sh"

mc_usage() {
  cat <<EOF
mac-cleaner - recurring folder cleanup routines

Usage:
  mc                  # interactive menu
  mc list             # list routines
  mc add              # add a routine via prompts
  mc delete           # delete a routine
  mc exec             # execute a routine now
  mc run --id <id> [--dry-run]  # used by launchd
EOF
}

mc_ensure_config

subcmd="${1:-menu}"
case "$subcmd" in
  list) mc_list_flow;;
  add) mc_add_flow;;
  delete) mc_delete_flow;;
  exec) mc_execute_flow;;
  run)
    shift
    run_id=""
    run_dry="false"
    while [[ $# -gt 0 ]]; do
      case "$1" in
        --id) run_id="$2"; shift 2;;
        --dry-run) run_dry="true"; shift;;
        *) shift;;
      esac
    done
    if [[ -z "$run_id" ]]; then
      mc_error "--id required"
      exit 1
    fi
    mc_clean_directory "$run_id" "$run_dry"
    ;;
  -h|--help) mc_usage;;
  *) mc_main_menu;;
esac

